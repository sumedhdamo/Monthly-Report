$Result = [ordered]@{
    ComputerName = $env:COMPUTERNAME
    SentinelOneInstalled = $false
    Method = ""
}

# 1. Check SentinelOne service (most reliable)
$service = Get-Service -Name "SentinelAgent" -ErrorAction SilentlyContinue
if ($service) {
    $Result.SentinelOneInstalled = $true
    $Result.Method = "Service: SentinelAgent"
}

# 2. Check program files (fallback)
if (-not $Result.SentinelOneInstalled) {
    if (Test-Path "C:\Program Files\SentinelOne") {
        $Result.SentinelOneInstalled = $true
        $Result.Method = "Program Files"
    }
}

# 3. Check registry uninstall keys (WMI-safe, fast)
if (-not $Result.SentinelOneInstalled) {
    $regPaths = @(
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    foreach ($path in $regPaths) {
        $app = Get-ItemProperty $path -ErrorAction SilentlyContinue |
               Where-Object { $_.DisplayName -match "Sentinel" }

        if ($app) {
            $Result.SentinelOneInstalled = $true
            $Result.Method = "Registry: $($app.DisplayName)"
            break
        }
    }
}

# Output result (RMM will capture this)
if ($Result.SentinelOneInstalled) {
    Write-Output "INSTALLED - $($Result.Method)"
} else {
    Write-Output "NOT INSTALLED"
}